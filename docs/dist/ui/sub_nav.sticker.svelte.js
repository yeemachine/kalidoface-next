import './sub_nav.sticker.svelte.css.proxy.js';
/* src/ui/sub_nav.sticker.svelte generated by Svelte v3.38.3 */
import {
	SvelteComponent,
	add_render_callback,
	add_transform,
	append,
	attr,
	check_outros,
	component_subscribe,
	create_animation,
	create_in_transition,
	create_out_transition,
	detach,
	element,
	fix_and_outro_and_destroy_block,
	fix_position,
	group_outros,
	init,
	insert,
	listen,
	noop,
	safe_not_equal,
	set_store_value,
	space,
	svg_element,
	toggle_class,
	transition_in,
	transition_out,
	update_keyed_each
} from "../../_snowpack/pkg/svelte/internal.js";

import { notifText } from "./notif.svelte.js";
import { randomString, isImageVideo } from "../utils/helpers.js";
import { stickerLayers, stickerList } from "../scene/stickers.svelte.js";
import { writable, get } from "../../_snowpack/pkg/svelte/store.js";
import { fade, fly, scale } from "../../_snowpack/pkg/svelte/transition.js";
import { cubicInOut } from "../../_snowpack/pkg/svelte/easing.js";
import { flip } from "../../_snowpack/pkg/svelte/animate.js";
import { DIM, setLang } from "../stores.js";
import { ftueState, updateFtue } from "./ftue.svelte.js";
import { dropzone } from "./filedrop.svelte.js";
import { subnav_sticker_text } from "../text/translations.js";

function get_each_context(ctx, list, i) {
	const child_ctx = ctx.slice();
	child_ctx[13] = list[i];
	child_ctx[15] = i;
	return child_ctx;
}

// (133:6) {:else}
function create_else_block(ctx) {
	let img;
	let img_src_value;
	let img_alt_value;
	let mounted;
	let dispose;

	function click_handler_1() {
		return /*click_handler_1*/ ctx[10](/*sticker*/ ctx[13]);
	}

	return {
		c() {
			img = element("img");
			attr(img, "class", "content svelte-11el58n");
			if (img.src !== (img_src_value = /*sticker*/ ctx[13].url)) attr(img, "src", img_src_value);
			attr(img, "alt", img_alt_value = "uploaded sticker" + /*i*/ ctx[15]);
		},
		m(target, anchor) {
			insert(target, img, anchor);

			if (!mounted) {
				dispose = listen(img, "click", click_handler_1);
				mounted = true;
			}
		},
		p(new_ctx, dirty) {
			ctx = new_ctx;

			if (dirty & /*$stickerList*/ 1 && img.src !== (img_src_value = /*sticker*/ ctx[13].url)) {
				attr(img, "src", img_src_value);
			}

			if (dirty & /*$stickerList*/ 1 && img_alt_value !== (img_alt_value = "uploaded sticker" + /*i*/ ctx[15])) {
				attr(img, "alt", img_alt_value);
			}
		},
		d(detaching) {
			if (detaching) detach(img);
			mounted = false;
			dispose();
		}
	};
}

// (131:6) {#if sticker.type==="video"}
function create_if_block_1(ctx) {
	let video;
	let video_src_value;
	let video_alt_value;
	let mounted;
	let dispose;

	function click_handler() {
		return /*click_handler*/ ctx[9](/*sticker*/ ctx[13]);
	}

	return {
		c() {
			video = element("video");
			attr(video, "class", "content svelte-11el58n");
			if (video.src !== (video_src_value = /*sticker*/ ctx[13].url)) attr(video, "src", video_src_value);
			attr(video, "alt", video_alt_value = "uploaded sticker" + /*i*/ ctx[15]);
			video.autoplay = true;
			video.muted = true;
			video.playsInline = true;
			video.loop = true;
		},
		m(target, anchor) {
			insert(target, video, anchor);

			if (!mounted) {
				dispose = listen(video, "click", click_handler);
				mounted = true;
			}
		},
		p(new_ctx, dirty) {
			ctx = new_ctx;

			if (dirty & /*$stickerList*/ 1 && video.src !== (video_src_value = /*sticker*/ ctx[13].url)) {
				attr(video, "src", video_src_value);
			}

			if (dirty & /*$stickerList*/ 1 && video_alt_value !== (video_alt_value = "uploaded sticker" + /*i*/ ctx[15])) {
				attr(video, "alt", video_alt_value);
			}
		},
		d(detaching) {
			if (detaching) detach(video);
			mounted = false;
			dispose();
		}
	};
}

// (138:6) {#if sticker.uploaded}
function create_if_block(ctx) {
	let button;
	let mounted;
	let dispose;

	function click_handler_2() {
		return /*click_handler_2*/ ctx[11](/*sticker*/ ctx[13]);
	}

	return {
		c() {
			button = element("button");

			button.innerHTML = `<i class="kalicon notranslate fill small svelte-11el58n">jellyfill</i> 
          <i class="kalicon notranslate solid small svelte-11el58n">minus</i>`;

			attr(button, "class", "remove svelte-11el58n");
		},
		m(target, anchor) {
			insert(target, button, anchor);

			if (!mounted) {
				dispose = listen(button, "click", click_handler_2);
				mounted = true;
			}
		},
		p(new_ctx, dirty) {
			ctx = new_ctx;
		},
		d(detaching) {
			if (detaching) detach(button);
			mounted = false;
			dispose();
		}
	};
}

// (124:4) {#each $stickerList as sticker,i (sticker)}
function create_each_block(key_1, ctx) {
	let div1;
	let div0;
	let t0;
	let t1;
	let div1_class_value;
	let div1_intro;
	let div1_outro;
	let rect;
	let stop_animation = noop;
	let current;

	function select_block_type(ctx, dirty) {
		if (/*sticker*/ ctx[13].type === "video") return create_if_block_1;
		return create_else_block;
	}

	let current_block_type = select_block_type(ctx, -1);
	let if_block0 = current_block_type(ctx);
	let if_block1 = /*sticker*/ ctx[13].uploaded && create_if_block(ctx);

	return {
		key: key_1,
		first: null,
		c() {
			div1 = element("div");
			div0 = element("div");
			if_block0.c();
			t0 = space();
			if (if_block1) if_block1.c();
			t1 = space();
			attr(div0, "class", "contentContainer svelte-11el58n");

			attr(div1, "class", div1_class_value = "sticker " + (/*$stickerLayers*/ ctx[1].length > 0 && /*checkIndex*/ ctx[7](/*sticker*/ ctx[13].url, /*$stickerLayers*/ ctx[1], "url") !== null
			? "selected"
			: "") + " svelte-11el58n");

			this.first = div1;
		},
		m(target, anchor) {
			insert(target, div1, anchor);
			append(div1, div0);
			if_block0.m(div0, null);
			append(div1, t0);
			if (if_block1) if_block1.m(div1, null);
			append(div1, t1);
			current = true;
		},
		p(new_ctx, dirty) {
			ctx = new_ctx;

			if (current_block_type === (current_block_type = select_block_type(ctx, dirty)) && if_block0) {
				if_block0.p(ctx, dirty);
			} else {
				if_block0.d(1);
				if_block0 = current_block_type(ctx);

				if (if_block0) {
					if_block0.c();
					if_block0.m(div0, null);
				}
			}

			if (/*sticker*/ ctx[13].uploaded) {
				if (if_block1) {
					if_block1.p(ctx, dirty);
				} else {
					if_block1 = create_if_block(ctx);
					if_block1.c();
					if_block1.m(div1, t1);
				}
			} else if (if_block1) {
				if_block1.d(1);
				if_block1 = null;
			}

			if (!current || dirty & /*$stickerLayers, $stickerList*/ 3 && div1_class_value !== (div1_class_value = "sticker " + (/*$stickerLayers*/ ctx[1].length > 0 && /*checkIndex*/ ctx[7](/*sticker*/ ctx[13].url, /*$stickerLayers*/ ctx[1], "url") !== null
			? "selected"
			: "") + " svelte-11el58n")) {
				attr(div1, "class", div1_class_value);
			}
		},
		r() {
			rect = div1.getBoundingClientRect();
		},
		f() {
			fix_position(div1);
			stop_animation();
			add_transform(div1, rect);
		},
		a() {
			stop_animation();
			stop_animation = create_animation(div1, rect, flip, { duration: 300 });
		},
		i(local) {
			if (current) return;

			if (local) {
				add_render_callback(() => {
					if (div1_outro) div1_outro.end(1);
					if (!div1_intro) div1_intro = create_in_transition(div1, scale, { duration: 250 });
					div1_intro.start();
				});
			}

			current = true;
		},
		o(local) {
			if (div1_intro) div1_intro.invalidate();

			if (local) {
				div1_outro = create_out_transition(div1, scale, { duration: 250 });
			}

			current = false;
		},
		d(detaching) {
			if (detaching) detach(div1);
			if_block0.d();
			if (if_block1) if_block1.d();
			if (detaching && div1_outro) div1_outro.end();
		}
	};
}

function create_fragment(ctx) {
	let container;
	let div1;
	let label;
	let div0;
	let svg;
	let rect;
	let t0;
	let i;
	let div0_data_text_value;
	let t2;
	let input;
	let t3;
	let each_blocks = [];
	let each_1_lookup = new Map();
	let div1_intro;
	let div1_outro;
	let container_data_text_value;
	let current;
	let mounted;
	let dispose;
	let each_value = /*$stickerList*/ ctx[0];
	const get_key = ctx => /*sticker*/ ctx[13];

	for (let i = 0; i < each_value.length; i += 1) {
		let child_ctx = get_each_context(ctx, each_value, i);
		let key = get_key(child_ctx);
		each_1_lookup.set(key, each_blocks[i] = create_each_block(key, child_ctx));
	}

	return {
		c() {
			container = element("container");
			div1 = element("div");
			label = element("label");
			div0 = element("div");
			svg = svg_element("svg");
			rect = svg_element("rect");
			t0 = space();
			i = element("i");
			i.textContent = "file";
			t2 = space();
			input = element("input");
			t3 = space();

			for (let i = 0; i < each_blocks.length; i += 1) {
				each_blocks[i].c();
			}

			attr(rect, "class", "dotted svelte-11el58n");
			attr(rect, "x", "4");
			attr(rect, "y", "4");
			attr(rect, "width", "291");
			attr(rect, "height", "291");
			attr(rect, "rx", "20");
			attr(svg, "viewBox", "0 0 300 300");
			attr(svg, "class", "svelte-11el58n");
			attr(i, "class", "kalicon notranslate solid variable svelte-11el58n");
			attr(div0, "data-text", div0_data_text_value = subnav_sticker_text.upload[/*$setLang*/ ctx[3]]);
			attr(div0, "class", "svelte-11el58n");
			attr(input, "type", "file");
			attr(input, "id", "uploadImage");
			attr(input, "name", "fileList");
			attr(input, "accept", ".jpg,.png,.gif,.mp4");
			attr(input, "class", "svelte-11el58n");
			attr(label, "class", "sticker svelte-11el58n");
			attr(label, "for", "uploadImage");
			attr(div1, "class", "sticker-list svelte-11el58n");
			attr(container, "data-text", container_data_text_value = subnav_sticker_text.upload[/*$setLang*/ ctx[3]]);
			attr(container, "class", "svelte-11el58n");
			toggle_class(container, "drop_zone", /*$dropzone*/ ctx[2]);
		},
		m(target, anchor) {
			insert(target, container, anchor);
			append(container, div1);
			append(div1, label);
			append(label, div0);
			append(div0, svg);
			append(svg, rect);
			append(div0, t0);
			append(div0, i);
			append(label, t2);
			append(label, input);
			append(div1, t3);

			for (let i = 0; i < each_blocks.length; i += 1) {
				each_blocks[i].m(div1, null);
			}

			current = true;

			if (!mounted) {
				dispose = listen(input, "change", /*handleClickUpload*/ ctx[5]);
				mounted = true;
			}
		},
		p(new_ctx, [dirty]) {
			ctx = new_ctx;

			if (!current || dirty & /*$setLang*/ 8 && div0_data_text_value !== (div0_data_text_value = subnav_sticker_text.upload[/*$setLang*/ ctx[3]])) {
				attr(div0, "data-text", div0_data_text_value);
			}

			if (dirty & /*$stickerLayers, checkIndex, $stickerList, removeImage, handleClick*/ 451) {
				each_value = /*$stickerList*/ ctx[0];
				group_outros();
				for (let i = 0; i < each_blocks.length; i += 1) each_blocks[i].r();
				each_blocks = update_keyed_each(each_blocks, dirty, get_key, 1, ctx, each_value, each_1_lookup, div1, fix_and_outro_and_destroy_block, create_each_block, null, get_each_context);
				for (let i = 0; i < each_blocks.length; i += 1) each_blocks[i].a();
				check_outros();
			}

			if (!current || dirty & /*$setLang*/ 8 && container_data_text_value !== (container_data_text_value = subnav_sticker_text.upload[/*$setLang*/ ctx[3]])) {
				attr(container, "data-text", container_data_text_value);
			}

			if (dirty & /*$dropzone*/ 4) {
				toggle_class(container, "drop_zone", /*$dropzone*/ ctx[2]);
			}
		},
		i(local) {
			if (current) return;

			for (let i = 0; i < each_value.length; i += 1) {
				transition_in(each_blocks[i]);
			}

			add_render_callback(() => {
				if (div1_outro) div1_outro.end(1);

				if (!div1_intro) div1_intro = create_in_transition(div1, fly, {
					x: /*$DIM*/ ctx[4].w > 600 ? 0 : 20,
					y: /*$DIM*/ ctx[4].w > 600 ? 20 : 0,
					easing: cubicInOut,
					duration: 400,
					delay: 200
				});

				div1_intro.start();
			});

			current = true;
		},
		o(local) {
			for (let i = 0; i < each_blocks.length; i += 1) {
				transition_out(each_blocks[i]);
			}

			if (div1_intro) div1_intro.invalidate();

			div1_outro = create_out_transition(div1, fade, {
				duration: /*$DIM*/ ctx[4].w > 600 ? 200 : 0
			});

			current = false;
		},
		d(detaching) {
			if (detaching) detach(container);

			for (let i = 0; i < each_blocks.length; i += 1) {
				each_blocks[i].d();
			}

			if (detaching && div1_outro) div1_outro.end();
			mounted = false;
			dispose();
		}
	};
}

const handleStickerImage = files => {
	for (var i = 0; i < files.length; i++) {
		let type = isImageVideo(files[i]);

		if (!type) {
			notifText.set({
				type: "error",
				"text": "Stickers can only be .jpg, .png, .gif or .mp4"
			});

			return;
		}

		const objectURL = URL.createObjectURL(files[i]);
		let reader = new FileReader();

		reader.onload = function (e) {
			let data = e.target.result;

			let newSticker = {
				url: objectURL,
				data,
				default: 0.5,
				type,
				uploaded: true,
				zIndex: get(stickerLayers).length + 1
			};

			stickerList.set([newSticker, ...get(stickerList)]);
			addSticker(newSticker);
		};

		reader.readAsDataURL(files[i]);
	}
};

const addSticker = sticker => {
	stickerLayers.set([
		...get(stickerLayers),
		{
			id: randomString(6, "0123456789"),
			url: sticker.url,
			type: sticker.type
			? sticker.type
			: sticker.url.includes(".mp4") ? "video" : "img",
			default: sticker.default,
			zIndex: get(stickerLayers).length + 1
		}
	]);
};

function instance($$self, $$props, $$invalidate) {
	let $stickerList;
	let $stickerLayers;
	let $dropzone;
	let $setLang;
	let $DIM;
	component_subscribe($$self, stickerList, $$value => $$invalidate(0, $stickerList = $$value));
	component_subscribe($$self, stickerLayers, $$value => $$invalidate(1, $stickerLayers = $$value));
	component_subscribe($$self, dropzone, $$value => $$invalidate(2, $dropzone = $$value));
	component_subscribe($$self, setLang, $$value => $$invalidate(3, $setLang = $$value));
	component_subscribe($$self, DIM, $$value => $$invalidate(4, $DIM = $$value));

	const handleClickUpload = e => {
		handleStickerImage(e.target.files);
	};

	//remove from sticker list
	const removeImage = url => {
		let layerIndex = checkIndex(url, $stickerList, "url");

		if (layerIndex !== null) {
			let newArray = $stickerList;
			newArray.splice(layerIndex, 1);

			if (layerIndex > -1) {
				set_store_value(stickerList, $stickerList = newArray, $stickerList);
			}
		}

		removeSticker(url);
		return layerIndex;
	};

	const checkIndex = (url, array, key) => {
		let index = null;

		array.forEach((e, i) => {
			if (e[key].includes(url)) {
				index = i;
				return;
			}
		});

		return index;
	};

	const removeSticker = url => {
		let layerIndex = checkIndex(url, $stickerLayers, "url");

		if (layerIndex !== null) {
			let newArray = $stickerLayers;
			newArray.splice(layerIndex, 1);

			if (layerIndex > -1) {
				stickerLayers.set(newArray);
			}
		}

		return layerIndex;
	};

	const handleClick = sticker => {
		let layerIndex = removeSticker(sticker.url);
		if (layerIndex !== null) return;
		addSticker(sticker);
	};

	const click_handler = sticker => {
		handleClick(sticker);
	};

	const click_handler_1 = sticker => {
		handleClick(sticker);
	};

	const click_handler_2 = sticker => {
		removeImage(sticker.url);
	};

	return [
		$stickerList,
		$stickerLayers,
		$dropzone,
		$setLang,
		$DIM,
		handleClickUpload,
		removeImage,
		checkIndex,
		handleClick,
		click_handler,
		click_handler_1,
		click_handler_2
	];
}

class Sub_nav_sticker extends SvelteComponent {
	constructor(options) {
		super();
		init(this, options, instance, create_fragment, safe_not_equal, {});
	}
}

export default Sub_nav_sticker;
export { handleStickerImage, addSticker };